(function(t,e){if("object"==typeof exports){var n=require("underscore"),r=require("backbone");module.exports=e(n,r)}else"function"==typeof define&&define.amd?define(["underscore","backbone"],e):t.Mask=e(t._,t.Backbone)})(this,function(_,Backbone){var NAMESPACE_DELIMITER=".",NAMESPACE_DELIMITER_EXP=/\./g,NAMESPACE_HOLD=":",PATH_ATTR=RegExp("(?:^|\\"+NAMESPACE_DELIMITER+"|"+NAMESPACE_HOLD+")(\\w+)$"),PATH_OBJ=RegExp("(\\w+)(?:$|"+NAMESPACE_DELIMITER+"|"+NAMESPACE_HOLD+")"),root=this,prevMask=this.Mask,LCAP="logic",LKEY="lkey",SKEY="skey",Abstract=function(){var t=function(e,n){return e instanceof t?e:this instanceof t?(this.data=n?e:{},this.enclose(e),void 0):new t(e,n)};_.extend(t.prototype,Backbone.Events,{extend:function(){return _.extend.apply(null,[this].concat(_.toArray(arguments))),this},enclose:function(t){this.set=function(n,r,i){return e(this,t,n,r,i),this},this.get=function(e){return t[e]},this.defaults=function(){return _.defaults.apply(null,[t].concat(_.toArray(arguments))),this},this.toJSON=function(){return JSON.strigify(t)}}});var e=function(t,n,r,i,s){var a,o,c,u={};if("string"!=typeof r){for(c in r)(o=e(t,n,c,r[c],i))&&(u[r]=o[0]);0!==_.size(u)&&t.trigger("change",u)}return a=n[r],a===i?null:(n[r]=i,s||void 0===a||console.warn('Abstract: override attribute "%s" = %o with %o while %s',r,a,i,n.status||"setting"),t.trigger("set change:"+r,i,a,r),[a])};return t}(),Compiler=function(){var t={compile:function(t,e){return this.source=t||this.source||"",this.options=e||this.options||{},this.lexer=this.define(),this.tokens=this.scan(),this.abstract=this.parse(),this.abstract},define:function(){var t=new Exp({source:"^#leftBound%logic#rightBound?$|^#leftBound?%logic#rightBound$",wildcards:{logic:"\\?|\\%id",leftBound:/.+/,rightBound:/.+/}}),e=[],n=[],r=[],i=[],s=[],a={source:"#delimiterL#logic{1,,\\s+}#delimiterR",global:!0,multiline:!0,captureRepetition:!0,wildcards:_.extend(this.options.wildcards,{delimiterL:e,delimiterR:n,logic:s}),assignments:{s:this.options.syntax,l:this.options.logic}};return _.chain(this.options.syntax).sort(function(t,e){return(e.priority||0)-(t.priority||0)||e.token.length-t.token.length}).each(function(s,a){s.behaviour=[],_.each(s.token.replace(/ /g,"%s").split("|"),function(o,c,u){var p=t.exec(o),l=p.cap("leftBound"),h=p.cap("rightBound"),d=l?s.trimBlockBound?"%ls"+l:l:!1,f=h?s.trimBlockBound?h+"%le":h:!1,g=-1===_.indexOf(r,d),m=-1===_.indexOf(i,f);p||console.error("Compiler: Invalid syntax definition in part %d of rule %s",c,s.skey),g&&m||console.warn("Compiler: non-unique part %d in syntax definition %s %o",c,s.skey,s),s.behaviour[c]={part:c,skey:s.skey,type:0!==c&&c===u.length-1?"closer":"opener",lb:d,rb:f},l&&(r.push(d),e.push("("+Exp.esc(d,!0)+")>s."+a+".behaviour."+c)),h&&(i.push(f),n.push("("+Exp.esc(f,!0)+")"+(g?">":">>")+"s."+a+".behaviour."+c))})}),_.chain(this.options.logic).sort(function(t,e){return(e.priority||0)-(t.priority||0)||e.exp.length-t.exp.length}).each(function(t,e){s.push("("+t.exp+")>l."+e)}),new Exp(a)},scan:function(t){var e=t||this.source,n=this.lexer.parse(e),r=n.map(function(t,e){return"string"==typeof t?"text "+e:t.atm("type")+" "+e+(" "+(t.atm("skey")||""))+(" "+(t.cap(["param"]).join(" ")||""))}).reverse().join("\n");return this.stream=r,n.value()},parse:function(t,e){for(var n,r,i,s,a,o,c,u=e||{namespace:this.namespace||"root",content:[[]],token:[]},p=t||this.stream,l=/^(text|closer|opener) (\d+)(?: (\w+))?(?: (\w+))?.*$/gm,h={};s=l.exec(p);)if(c=this.tokens[s[2]],this.trigger&&"text"!==s[1]&&(this.trigger("parse:syntax:"+c.atm("skey"),c,n={namespace:"",content:[],token:[]},h={complete:!0,valid:!0,namespace:c.cap("namespace")||c.cap("param")||""}),c.cap("logic")&&c.cap("logic").each(function(t){this.trigger("parse:logic:"+t.atm("lkey"),c,n,h,t)},this)),h.valid||"text"===s[1]){switch(h={},s[1]){case"text":n=this.tokens[s[2]];break;case"closer":for(n.token.splice(0,0,c),r=RegExp("^(opener) (\\d+) ("+s[3]+") .*("+s[4]+").*$","gm"),i=RegExp("^(opener) (\\d+) ("+s[3]+").*$","gm"),r.lastIndex=i.lastIndex=l.lastIndex;!h.complete&&(a=r.exec(p)||i.exec(p));)c=this.tokens[a[2]],this.trigger&&(this.trigger("parse:syntax:"+c.atm("skey"),c,n,h={complete:!0,valid:!0,namespace:c.cap("namespace")||c.cap("param")||""}),c.cap("logic").each(function(t){this.trigger("parse:logic:"+t.atm("lkey"),c,n,h,t)},this)),r.lastIndex=i.lastIndex=a.index+a[0].length,h.valid&&(n.token.splice(0,0,c),o=p.slice(l.lastIndex,a.index),n.namespace=n.namespace||u.namespace+NAMESPACE_DELIMITER+h.namespace,l.lastIndex=a.index+a[0].length,""!==o&&(n.content.splice(0,0,[]),this.parse(o,n)));break;case"opener":n.token.splice(0,0,c)}u.content[0].push(n)}return _.invoke(u.content,"reverse"),u}};return t}(),Generator=function(){var t={generate:function(t,e){var n=this._template[t||this.option.template]||console.error("Generator: The template"+t+"do not exist."),r=n.tokens.slice(0);this._translator,e=e||this.asbtract||{};for(var i in n.key)r[i]=this.translate(e,n.key[i]);return r.join("")},translate:function(t,e){var n=e.toLowerCase(),r=this._translator[e]||this._translator[n];return r&&r.call(this,t,e)||t[e]||t[n]||e},addTemplate:function(e,n){var r,i,s,a={tokens:[],key:{}},o=0;switch(this._template||(this._template={}),this._template[n]&&console.warn('Generator: Overwrite template "%s"',n),typeof e){case"function":e=""+e;case"string":for(r=this._keyList.exec(e)||{},i=r[1]?r[1].split(/\s*,\s*/):[],i.push("_([A-Z]+)_"),i=RegExp(i.join("|"),"g"),e=e.slice(this._keyList.lastIndex||e.indexOf("{")+1,e.lastIndexOf("}")),(s=this._offset.exec(e)[0]).length&&(e=e.replace(RegExp("(^|\\n)"+t.esc(s,!0),"g"),"$1")),e=e.replace(/\s*$/,"");r=i.exec(e);)a.tokens.push(e.slice(o,r.index),void 0),a.key[a.tokens.length-1]=r[1]||r[0],o=i.lastIndex;a.tokens.push(e.slice(o)),this._template[n]=a,this._keyList.lastIndex=0;break;case"object":this._template[n]=e}return this},addTranslator:function(t,e){return this._translator[e]&&console.warn('Generator: Overwrite translator "%s"',e),this._translator[e]=t,this},_template:{},_translator:{},_offset:/^[\s\t]*/,_keyList:/\s*\/\*\*\s*@marker\s*\*\/\s*var\s*([^;]+)\s*;\n*/g,esc:function(t){return t.replace(/[\\]/g,"\\\\").replace(/[\"]/g,'\\"').replace(/[\b]/g,"\\b").replace(/[\f]/g,"\\f").replace(/[\n]/g,"\\n").replace(/[\r]/g,"\\r").replace(/[\t]/g,"\\t")},stringify:function(t){return'"'+this.esc(t)+'"'}};return t}(),View=function(){var t=function(t){this.data={},this.meta={},this.parent={},this.nested=[],this.index=0,this.getData=_.bind(this.getData,this),this._configure(t||{}),this.initialize.apply(this,arguments),void 0!==this.parent.nested&&(this.index=this.parent.nested.push(this)-1)},e=["data","meta","parent"];return t.prototype={initialize:function(){},nest:function(t,e){var n=Mask.v[e],r={i:0,n:0};return void 0===n?"":_.chain(makeArray(t)).map(function(t,e,i){return r.i=e,r.n=i.length,n.create({data:t,meta:r,parent:this}).render()},this).tap(function(){delete r.i,r.n}).join("").value()},render:function(){return""},handle:function(t,e){var n=this.getData(t);switch(typeof n){case"string":case"number":return n;case"boolean":return n?PATH_ATTR.exec(t)[1]:"";case"object":return this.nest(n,e);default:return""}},getData:function(t){return lookup(t,this.data,this.parent.getData,this.meta)},addData:function(){var t=this;return _.each(arguments,function(e){this.getData=function(n){return lookup(n,e,t.getData,t.meta)}},this),this},_configure:function(t){this.options&&(t=_.extend({},this.options,t));for(var n=0,r=e.length;r>n;n++){var i=e[n];t[i]&&(this[i]=t[i])}this.options=t}},t.create=function(t){return new this(t)},t}(),Mask=function(){var t=function(t){this.init(t)};_.extend(t.prototype,Compiler,Generator,Backbone.Events,{init:function(t){t=_.isObject(t)?t:e[t]||e["default"],this.options={},this.configure(n,e[t.preset]||{},t),_.each(this.options.templates,this.addTemplate,this),_.each(this.options.translator,this.addTranslator,this),this.on(this.options.events||this.options.on||{})},configure:function(){options.apply(this,_(arguments).splice(0,0,this.options))},register:function(t,e){var n=this.generate(e||this.options.template,"string"==typeof t?this.compile(t):t);appendScript(n)},create:function(e,n){return t.create(e,n)},_translator:{content:function(t,e){var n,r,i=this,s=t.content.length;return t.content[0]?(n={contents:_.map(t.content,function(e,n){var a=t.token[n];return r={content:_.map(e,function(t){return"string"==typeof t?Generator.stringify(t):i.translate(t,"token")}).join(" + "),token:a,"abstract":t,index:n,first:0===n,last:n===s-1},i.trigger("generate:content",r),a&&a.cap(LCAP).each(function(t){i.trigger("generate:logic:"+t.atm(LKEY),r)}),r.content},this),"abstract":t},i.trigger("generate:block",n),chain(n.contents).flatten().join("").value()):e},token:function(t){var e=t.viewPath||t.content&&t.namespace&&t.content.length,n=t.dataPath||t.token[0].cap("namespace"),r=t.viewPath||e&&t.namespace;return e&&this.register(t),"$.handle('"+n+"'"+(r?", '"+r+"'":"")+")"}},debug:!0}),_.extend(t,{create:function(t,e){return _.isFunction(this.v[t])||console.error("The view class  >>"+t+"<< doesn't exist"),new this.v[t](e)},noconflict:function(){return root.Mask=prevMask,this},v:{}});var e=t.presets={"default":{}},n=t.defaults={data:{},syntax:[{skey:"mustache",token:"{{ ? }}"}],wildcards:{id:"(#param:%ns)",ns:"%w(?:\\.%w)*",ls:"(?:^[ \\t]*)?",le:"\\n?",n:"\\n",s:"[ \\t]*",w:"\\w+",namespace:"%ns",path:"\\w+(?:\\.(?:\\w+|\\[\\d+\\]))*"},multipleLogic:!0,logic:[{lkey:"path",exp:"(#param:#namespace)"}],template:"View",templates:{View:function(){var e;t.v.NAMESPACE=t.View.extend({render:function(t){var n=this;return t&&(n.data=t),e},initialize:function(){}})}},translator:{},preset:"html",cache:!0};return t}(),Console=function(t){if(n)return n;var e,n=function(t){var e=t||{};this.quiet=!!e.quiet},r=!window,i=navigator&&/phantom/i.test(navigator.userAgent),s={warn:"Warning: ",log:"",error:"Error: "},a=/%([sdo])/g;n.quiet=!1,n.format=function(e){var n=[].slice.call(e),s="string"==typeof n[0];return r&&s&&(n[0]=n[0].replace(/%o/g,"%j")),(!t||i)&&s&&n.length>1&&(n[0]=n[0].replace(a,function(t,e){if(!n[1])return t;var r=n.splice(1,1)[0];switch(e){case"s":return""+r;case"d":return parseInt(r);case"f":return parseFloat(r);default:return JSON&&JSON.stringify(r)||""+r}})),n},n.prototype.put=function(t){window.setTimeout(function(){throw t},1),c.log("test")};for(e in s)(function(e,r){n[e]=n.prototype[e]=function(){var i=n.format(arguments);return!this.quiet&&(t&&t[e]&&!t[e].apply(t,i)||this.put(r+i.join()))}})(e,s[e].toUpperCase());return n}((window||global).console),options=function(t){return _.each(_(arguments).slice(1),function(e){if(e)for(var n in e)t[n]=_.isArray(e[n])&&_.isArray(t[n])?e[n].concat(t[n]):_.isObject(e[n])&&_.isObject(t[n])?options({},t[n],e[n]):e[n]}),t},isArray=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},makeArray=function(t){return isArray(t)?t:[t]},resolve=Mask.resolve=function(namespace,obj,delimitter){delimitter=delimitter||NAMESPACE_DELIMITER_EXP,obj=obj||window,namespace=namespace.split(delimitter);try{return eval('(obj["'+namespace.join('"]["')+'"])')}catch(e){return void 0}},lookup=function(t,e,n,r){var i,s=t[0]===NAMESPACE_DELIMITER,a=t[0]===NAMESPACE_HOLD,o=t.slice(s||a),c=r||{};return""===o?e:void 0!==(i=e[o]||c[o])?i:void 0!==(i=resolve(o,e))?i:n&&!a?n(o):void 0},extend=function(t,e){var n,r=this;n=t&&_.has(t,"constructor")?t.constructor:function(){r.apply(this,arguments)},_.extend(n,r,e);var i=function(){this.constructor=n};return i.prototype=r.prototype,n.prototype=new i,t&&_.extend(n.prototype,t),n.__super__=r.prototype,n},jsSource=/\.js/i,appendScript=function(t){var e=(document.getElementsByTagName("head"),document.createElement("script"));e.type="text/javascript",jsSource.test(e)?e.src=t:e.text=t,document.body.appendChild(e),document.body.removeChild(document.body.lastChild)},output=function(t,e){_.rest(arguments),_.defer(function(){throw t.toUpperCase()+e}),console.log("test"),console.warn("foo %s","bar")},console=new Console({quiet:!1}),chain=_.chain,console=new Console({quiet:!1});return View.extend=extend,Mask.Abstract=Abstract,Mask.View=View,Mask.Generator=Generator,Mask.VERSION="0.2.0",Mask});