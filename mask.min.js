/*! mask.js - v0.1.1 - 2013-04-21
 * https://github.com/sbekoe/maskjs
 * Copyright (c) 2013 Simon Bekoe; Licensed MIT */
(function(e,t){if(typeof exports=="object"){var n=require("underscore"),r=require("backbone");module.exports=t(n,r)}else typeof define=="function"&&define.amd?define(["underscore","backbone"],t):e.Mask=t(e._,e.Backbone)})(this,function(_,Backbone){var NAMESPACE_DELIMITER=".",NAMESPACE_DELIMITER_EXP=/\./g,NAMESPACE_HOLD=":",PATH_ATTR=RegExp("(?:^|\\"+NAMESPACE_DELIMITER+"|"+NAMESPACE_HOLD+")(\\w+)$"),PATH_OBJ=RegExp("(\\w+)(?:$|"+NAMESPACE_DELIMITER+"|"+NAMESPACE_HOLD+")"),root=this,prevMask=this.Mask,Compiler=function(){var e={compile:function(e,t){return this.source=e||this.source||"",this.options=t||this.options||{},this.lexer=this.define(),this.tokens=this.scan(),this.abstract=this.parse(),this.abstract},define:function(){var e=new Exp({source:"^#leftBound%logic#rightBound?$|^#leftBound?%logic#rightBound$",wildcards:{logic:"\\?|\\%id",leftBound:/.+/,rightBound:/.+/}}),t=[],n=[],r=[],i=[],s=[],o={source:"#delimiterL#logic{1,,\\s+}#delimiterR",global:!0,multiline:!0,captureRepetition:!0,wildcards:_.extend(this.options.wildcards,{delimiterL:t,delimiterR:n,logic:s}),assignments:{s:this.options.syntax,l:this.options.logic}};return _.chain(this.options.syntax).sort(function(e,t){return(t.priority||0)-(e.priority||0)||t.token.length-e.token.length}).each(function(s,o){s.behaviour=[],_.each(s.token.replace(/ /g,"%s").split("|"),function(u,a,f){var l=e.exec(u),c=l.leftBound?s.trimBlockBound?"%ls"+l.leftBound:l.leftBound[0]:!1,h=l.rightBound?s.trimBlockBound?l.rightBound+"%le":l.rightBound[0]:!1,p=-1===_.indexOf(r,c),d=-1===_.indexOf(i,h);error(!l,"(compiler) Invalid syntax definition in part "+a+" of rule "+s.skey),log(!p||!d,"(compiler) Warning: non-unique part "+a+" in syntax definition "+s.skey),s.behaviour[a]={part:a,skey:s.skey,type:a!==0&&a===f.length-1?"closer":"opener",lb:c,rb:h},l.leftBound&&(r.push(c),t.push("("+Exp.esc(c,!0)+")>s."+o+".behaviour."+a)),l.rightBound&&(i.push(h),n.push("("+Exp.esc(h,!0)+")"+(p?">":">>")+"s."+o+".behaviour."+a))})}),_.chain(this.options.logic).sort(function(e,t){return(t.priority||0)-(e.priority||0)||t.exp.length-e.exp.length}).each(function(e,t){s.push("("+e.exp+")>l."+t)}),new Exp(o)},scan:function(e){var t=e||this.source,n=[],r,i;return r=this.lexer.scan(t,function(e,r){return(i=t.slice(e.lastRange[1],e.range[0]))&&r.push("text "+(n.push(i)-1)),e.type+" "+(n.push(e)-1)+(" "+(e.skey||""))+(" "+(e.param.join(" ")||""))}),this.lexer.lastMatch&&r.push("text "+(n.push(t.slice(this.lexer.lastMatch.range[1]))-1)),this.stream=r.reverse().join("\n"),n},parse:function(e,t){var n=this,r=t||{namespace:this.namespace||"root",content:[[]],token:[[]]},i=e||this.stream,s,o=/^(text|closer|opener) (\d+)(?: (\w+))?(?: (\w+))?.*$/gm,u,a,f,l,c,h={},p;while(f=o.exec(i)){p=this.tokens[f[2]],this.trigger&&(this.trigger("parse:syntax:"+p.skey,p,s={namespace:"",content:[],token:[]},h={complete:!0,valid:!0,namespace:p.namespace?p.namespace[0]:p.param?p.param[0]:""}),p.logic&&_.each(p.logic[0],function(e){this.trigger("parse:logic:"+e.lkey,p,s,h,e)},this));if(!h.valid)continue;s.token.splice(0,0,p),h={};switch(f[1]){case"text":s=this.tokens[f[2]];break;case"closer":u=new RegExp("^(opener) (\\d+) ("+f[3]+") .*("+f[4]+").*$","gm"),a=new RegExp("^(opener) (\\d+) ("+f[3]+").*$","gm"),u.lastIndex=a.lastIndex=o.lastIndex;while(!h.complete&&(l=u.exec(i)||a.exec(i))){p=this.tokens[l[2]],this.trigger&&(this.trigger("parse:syntax:"+p.skey,p,s,h={complete:!0,valid:!0,namespace:p.namespace?p.namespace[0]:p.param?p.param[0]:""}),_.each(p.logic[0],function(e){this.trigger("parse:logic:"+e.lkey,p,s,h,e)},this)),u.lastIndex=a.lastIndex=l.index+l[0].length;if(!h.valid)continue;s.token.splice(0,0,p),c=i.slice(o.lastIndex,l.index),s.namespace=r.namespace+NAMESPACE_DELIMITER+h.namespace,o.lastIndex=l.index+l[0].length,c!==""&&(s.content.splice(0,0,[]),this.parse(c,s))}break;case"opener":}r.content[0].push(s)}return _.invoke(r.content,"reverse"),r}};return e}(),Generator=function(){var e={generate:function(e,t){var n=this._template[e||this.option.template]||error(this.debug,"(generator) The template"+e+"do not exist."),r=n.tokens.slice(0),i=this._translator,s,o,u;t=t||this.asbtract||{};for(var a in n.key)s=n.key[a],o=s.toLowerCase(),r[a]=i[s]&&(u=i[s].call(this,t,s))!==undefined?u:i[o]&&(u=i[o].call(this,t,s))!==undefined?u:t[s]||t[o]||s;return r.join("")},addTemplate:function(t,n){var r,i,s={tokens:[],key:{}},o=0,u;this._template||(this._template={}),log(!!this._template[n],'(generator) Overwrite template "'+n+'"');switch(typeof t){case"function":t=t.toString();case"string":r=this._keyList.exec(t)||{},i=r[1]?r[1].split(/\s*,\s*/):[],i.push("_([A-Z]+)_"),i=new RegExp(i.join("|"),"g"),t=t.slice(this._keyList.lastIndex||t.indexOf("{")+1,t.lastIndexOf("}")),(u=this._offset.exec(t)[0]).length&&(t=t.replace(new RegExp("(^|\\n)"+e.esc(u,!0),"g"),"$1")),t=t.replace(/\s*$/,"");while(r=i.exec(t))s.tokens.push(t.slice(o,r.index),undefined),s.key[s.tokens.length-1]=r[1]||r[0],o=i.lastIndex;s.tokens.push(t.slice(o)),this._template[n]=s,this._keyList.lastIndex=0;break;case"object":this._template[n]=t}return this},addTranslator:function(e,t){return log(!!this._translator[t],'(generator) Overwrite translator "'+t+'"'),this._translator[t]=e,this},_template:{},_translator:{},_offset:/^[\s\t]*/,_keyList:/\s*\/\*\*\s*@marker\s*\*\/\s*var\s*([^;]+)\s*;\n*/g,esc:function(e){return e.replace(/[\\]/g,"\\\\").replace(/[\"]/g,'\\"').replace(/[\b]/g,"\\b").replace(/[\f]/g,"\\f").replace(/[\n]/g,"\\n").replace(/[\r]/g,"\\r").replace(/[\t]/g,"\\t")},stringify:function(e){return'"'+this.esc(e)+'"'}};return e}(),View=function(){var e=function(e){this.data={},this.meta={},this.parent={},this.nested=[],this.index=0,this.getData=_.bind(this.getData,this),this._configure(e||{}),this.initialize.apply(this,arguments),this.parent.nested!==undefined&&(this.index=this.parent.nested.push(this)-1)},t=["data","meta","parent"];return e.prototype={initialize:function(){},nest:function(e,t){var n=Mask.v[t],r={i:0,n:0};return n===undefined?"":_.chain(makeArray(e)).map(function(e,t,i){return r.i=t,r.n=i.length,n.create({data:e,meta:r,parent:this}).render()},this).tap(function(){delete r.i,r.n}).join("").value()},render:function(){return""},handle:function(e,t){var n=this.getData(e);switch(typeof n){case"string":case"number":return n;case"boolean":return n?PATH_ATTR.exec(e)[1]:"";case"object":return this.nest(n,t);default:return""}},getData:function(e){return lookup(e,this.data,this.parent.getData,this.meta)},addData:function(){var e=this;return _.each(arguments,function(t){this.getData=function(n){return lookup(n,t,e.getData,e.meta)}},this),this},_configure:function(e){this.options&&(e=_.extend({},this.options,e));for(var n=0,r=t.length;n<r;n++){var i=t[n];e[i]&&(this[i]=e[i])}this.options=e}},e.create=function(e){return new this(e)},e}(),Mask=function(){var e=function(e){this.init(e)};_.extend(e.prototype,Compiler,Generator,Backbone.Events,{init:function(e){e=_.isObject(e)?e:t[e]||t["default"],this.options={},this.configure(n,t[e.preset]||{},e),_.each(this.options.templates,this.addTemplate,this),_.each(this.options.translator,this.addTranslator,this),this.on(this.options.events||this.options.on||{})},configure:function(){options.apply(this,_(arguments).splice(0,0,this.options))},register:function(e,t){var n=this.generate(t||this.options.template,typeof e=="string"?this.compile(e):e);appendScript(n)},create:function(t,n){return e.create(t,n)},_translator:{content:function(e,t){var n=this,r=e.content[0],i=this.options.logic,s,o;return r?_.reduce(e.content,function(r,i,u){return n.trigger("generate:block:"+e.token[u].lkey,s={content:_.map(i,function(r,i){return n.trigger("generate:token:"+e.token[u].lkey,o={content:typeof r=="string"?Generator.stringify(r):n._translator.token.call(n,r,t),index:i,"abstract":e}),o.content}).join(" + "),token:e.token[u],index:u,"abstract":e}),r+s.content},""):t},token:function(e,t){var n=!!e.content.length;return n&&this.register(e),"$.handle('"+e.token[0].namespace+"'"+(n?", '"+e.namespace+"'":"")+")"}},debug:!0}),_.extend(e,{create:function(e,t){return error(!_.isFunction(this.v[e]),"The view class  >>"+e+"<< doesn't exist"),new this.v[e](t)},noconflict:function(){return root.Mask=prevMask,this},v:{}});var t=e.presets={"default":{}},n=e.defaults={data:{},syntax:[{skey:"mustache",token:"{{ ? }}"}],wildcards:{id:"(#param:%ns)",ns:"%w(?:\\.%w)*",ls:"(?:^[ \\t]*)?",le:"\\n?",n:"\\n",s:"[ \\t]*",w:"\\w+",namespace:"%ns",path:"\\w+(?:\\.(?:\\w+|\\[\\d+\\]))*"},multipleLogic:!0,logic:[{lkey:"path",exp:"(#param:#namespace)"}],template:"View",templates:{View:function(){var t,n;e.v.NAMESPACE=e.View.extend({render:function(e){var t=this;return e&&(t.data=e),n},initialize:function(){}})}},translator:{},preset:"html",cache:!0};return e}(),options=function(e){return _.each(_(arguments).slice(1),function(t){if(t)for(var n in t)_.isArray(t[n])&&_.isArray(e[n])?e[n]=t[n].concat(e[n]):_.isObject(t[n])&&_.isObject(e[n])?e[n]=options({},e[n],t[n]):e[n]=t[n]}),e},isArray=Array.isArray||function(e){return Object.prototype.toString.call(e)==="[object Array]"},makeArray=function(e){return isArray(e)?e:[e]},resolve=Mask.resolve=function(namespace,obj,delimitter){delimitter=delimitter||NAMESPACE_DELIMITER_EXP,obj=obj||window,namespace=namespace.split(delimitter);try{return eval('(obj["'+namespace.join('"]["')+'"])')}catch(e){return undefined}},lookup=function(e,t,n,r){var i,s=e[0]===NAMESPACE_DELIMITER,o=e[0]===NAMESPACE_HOLD,u=e.slice(s||o),a=r||{};return u===""?t:(i=t[u]||a[u])!==undefined?i:(i=resolve(u,t))!==undefined?i:n&&!o?n(u):undefined},extend=function(e,t){var n=this,r;e&&_.has(e,"constructor")?r=e.constructor:r=function(){n.apply(this,arguments)},_.extend(r,n,t);var i=function(){this.constructor=r};return i.prototype=n.prototype,r.prototype=new i,e&&_.extend(r.prototype,e),r.__super__=n.prototype,r},jsSource=/\.js/i,appendScript=function(e){var t=document.getElementsByTagName("head"),n=document.createElement("script");n.type="text/javascript",jsSource.test(n)?n.src=e:n.text=e,document.body.appendChild(n),document.body.removeChild(document.body.lastChild)},error=function(e,t){if(e===!0)throw new Error("maskjs error: "+t)},log=function(e,t){e===!0&&console&&console.log&&console.log("maskjs log: "+t)};return View.extend=extend,Mask.View=View,Mask.Generator=Generator,Mask.VERSION="0.1.1",Mask});